{% extends "base.html" %}

{% block content %}
<div class="project-details-container">
    <!-- Header Section -->
    <div class="project-header">
        <div class="header-content">
            <h1>{{ project.title }}</h1>
            <div class="project-meta">
                <span class="project-status status-{{ project.status | lower | replace(' ', '-') }}">
                    {{ project.status }}
                </span>
                <span class="created-date">
                    Created: {{ project.created_at.strftime('%Y-%m-%d') }}
                </span>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="history.back()">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
            <button class="btn btn-secondary" onclick="window.location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Project Overview -->
    <div class="overview-section">
        <div class="overview-grid">
            <div class="overview-card">
                <h3><i class="fas fa-user-graduate"></i> Mentee</h3>
                <p>{{ mentee.username if mentee else 'Not assigned' }}</p>
                {% if mentee and mentee.profile.full_name %}
                <p class="text-muted">{{ mentee.profile.full_name }}</p>
                {% endif %}
            </div>
            
            <div class="overview-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Mentor</h3>
                <p>{{ mentor.username if mentor else 'Not assigned' }}</p>
                {% if mentor and mentor.profile.full_name %}
                <p class="text-muted">{{ mentor.profile.full_name }}</p>
                {% endif %}
            </div>
            
            <div class="overview-card">
                <h3><i class="fas fa-tasks"></i> Progress</h3>
                <div class="progress-container">
                    <div class="progress-bar" style="width: {{ completion_percentage }}%"></div>
                    <span class="progress-text">{{ completed_tasks }}/{{ total_tasks }} tasks</span>
                </div>
                <p class="percentage">{{ completion_percentage | round(1) }}% Complete</p>
            </div>
            
            <div class="overview-card">
                <h3><i class="fas fa-calendar"></i> Timeline</h3>
                <p>Created: {{ project.created_at.strftime('%b %d, %Y') }}</p>
                {% if project.updated_at %}
                <p>Updated: {{ project.updated_at.strftime('%b %d, %Y') }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-button active" data-tab="description">Description</button>
            <button class="tab-button" data-tab="tasks">Tasks ({{ total_tasks }})</button>
            <button class="tab-button" data-tab="feedback">Feedback ({{ feedback_history | length }})</button>
            <button class="tab-button" data-tab="files">Files ({{ project_files | length }})</button>
            <button class="tab-button" data-tab="activity">Activity</button>
        </div>

        <div class="tabs-content">
            <!-- Description Tab -->
            <div class="tab-pane active" id="description">
                <div class="description-content">
                    <h3>Project Description</h3>
                    <p>{{ project.description or 'No description provided.' }}</p>
                    
                    {% if mentee and mentee.profile %}
                    <div class="mentee-info">
                        <h4>Mentee Information</h4>
                        <div class="info-grid">
                            {% if mentee.profile.skills %}
                            <div>
                                <strong>Skills:</strong>
                                <span>{{ mentee.profile.skills | join(', ') }}</span>
                            </div>
                            {% endif %}
                            {% if mentee.profile.interests %}
                            <div>
                                <strong>Interests:</strong>
                                <span>{{ mentee.profile.interests | join(', ') }}</span>
                            </div>
                            {% endif %}
                            {% if mentee.profile.goals %}
                            <div>
                                <strong>Goals:</strong>
                                <span>{{ mentee.profile.goals }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tasks Tab -->
            <div class="tab-pane" id="tasks">
                <div class="tasks-header">
                    <h3>Project Tasks</h3>
                    <button class="btn btn-success" id="addTaskBtn">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </div>
                
                <div class="tasks-list">
                    {% if project.tasks %}
                        {% for task in project.tasks %}
                        <div class="task-item {% if task.completed %}completed{% endif %}">
                            <div class="task-checkbox">
                                <input type="checkbox" 
                                       data-project-id="{{ project._id }}" 
                                       data-task-id="{{ task._id }}"
                                       {% if task.completed %}checked{% endif %}
                                       onchange="updateTaskStatus(this)">
                            </div>
                            <div class="task-content">
                                <div class="task-header">
                                    <h4>{{ task.name }}</h4>
                                    <span class="task-status">
                                        {% if task.completed %}
                                        <i class="fas fa-check-circle text-success"></i> Completed
                                        {% else %}
                                        <i class="fas fa-clock text-warning"></i> Pending
                                        {% endif %}
                                    </span>
                                </div>
                                {% if task.description %}
                                <p class="task-description">{{ task.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-tasks">No tasks have been added to this project yet.</p>
                    {% endif %}
                </div>

                <!-- Add Task Form (hidden by default) -->
                <div class="add-task-form" id="addTaskForm" style="display: none;">
                    <h4>Add New Task</h4>
                    <form id="taskForm">
                        <div class="form-group">
                            <label for="taskName">Task Name:</label>
                            <input type="text" id="taskName" name="task_name" required>
                        </div>
                        <div class="form-group">
                            <label for="taskDescription">Description (optional):</label>
                            <textarea id="taskDescription" name="task_description" rows="3"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Add Task</button>
                            <button type="button" class="btn btn-secondary" onclick="hideTaskForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Feedback Tab -->
            <div class="tab-pane" id="feedback">
                <div class="feedback-header">
                    <h3>Project Feedback</h3>
                    <button class="btn btn-primary" onclick="showFeedbackModal()">
                        <i class="fas fa-comment"></i> Add Feedback
                    </button>
                </div>
                
                <div class="feedback-list">
                    {% if feedback_history %}
                        {% for feedback in feedback_history %}
                        <div class="feedback-item">
                            <div class="feedback-header">
                                <strong>
                                    {% if feedback.mentor_id|string == session.user_id %}
                                    You
                                    {% else %}
                                    Mentor
                                    {% endif %}
                                </strong>
                                <span class="feedback-date">
                                    {{ feedback.timestamp.strftime('%b %d, %Y at %H:%M') }}
                                </span>
                            </div>
                            <div class="feedback-rating">
                                {% if feedback.rating %}
                                Rating: 
                                {% for i in range(5) %}
                                <i class="fas fa-star {% if i < feedback.rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                {% endfor %}
                                {% endif %}
                            </div>
                            <p class="feedback-comments">{{ feedback.comments }}</p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-feedback">No feedback has been provided yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Files Tab -->
            <div class="tab-pane" id="files">
                <div class="files-header">
                    <h3>Project Files</h3>
                    <button class="btn btn-primary" onclick="showUploadForm()">
                        <i class="fas fa-upload"></i> Upload File
                    </button>
                </div>
                
                <div class="files-list">
                    {% if project_files %}
                        {% for file in project_files %}
                        <div class="file-item">
                            <i class="fas fa-file"></i>
                            <div class="file-info">
                                <strong>{{ file.original_name }}</strong>
                                <span>Uploaded: {{ file.uploaded_at.strftime('%b %d, %Y') }}</span>
                            </div>
                            <a href="/download/{{ file._id }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download"></i> Download
                            </a>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-files">No files have been uploaded yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Activity Tab -->
            <div class="tab-pane" id="activity">
                <h3>Project Activity</h3>
                <div class="activity-timeline">
                    {% if activity_history %}
                        {% for activity in activity_history %}
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-{{ 
                                    'user' if activity.action_type == 'User Login' else 
                                    'task' if 'Task' in activity.action_type else 
                                    'comment' if 'Feedback' in activity.action_type else 
                                    'file' if 'File' in activity.action_type else 'info' 
                                }}"></i>
                            </div>
                            <div class="activity-content">
                                <p>{{ activity.description }}</p>
                                <span class="activity-time">
                                    {{ activity.timestamp.strftime('%b %d, %Y at %H:%M') }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-activity">No activity recorded for this project.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>Add Feedback</h3>
        <form id="feedbackForm">
            <div class="form-group">
                <label for="rating">Rating (1-5):</label>
                <div class="rating-stars">
                    {% for i in range(1, 6) %}
                    <i class="fas fa-star" data-rating="{{ i }}"></i>
                    {% endfor %}
                </div>
                <input type="hidden" id="rating" name="rating" required>
            </div>
            <div class="form-group">
                <label for="comments">Comments:</label>
                <textarea id="comments" name="comments" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Feedback</button>
        </form>
    </div>
</div>

<style>
.project-details-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.project-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
}

.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.overview-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tabs-container {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tabs-header {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.tab-button {
    padding: 15px 20px;
    border: none;
    background: none;
    cursor: pointer;
    border-bottom: 3px solid transparent;
}

.tab-button.active {
    border-bottom-color: #007bff;
    color: #007bff;
}

.tabs-content {
    padding: 20px;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

.task-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    margin-bottom: 10px;
}

.task-item.completed {
    background-color: #f8fff8;
    border-color: #d4edda;
}

.feedback-item, .file-item, .activity-item {
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    margin-bottom: 10px;
}

.rating-stars {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
}

.rating-stars .fas:hover,
.rating-stars .fas.active {
    color: #ffc107;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
}
</style>

<script>
// Tab functionality
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
        // Remove active class from all buttons and panes
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        
        // Add active class to clicked button and corresponding pane
        button.classList.add('active');
        document.getElementById(button.dataset.tab).classList.add('active');
    });
});

// Task management
document.getElementById('addTaskBtn').addEventListener('click', () => {
    document.getElementById('addTaskForm').style.display = 'block';
});

function hideTaskForm() {
    document.getElementById('addTaskForm').style.display = 'none';
}

async function updateTaskStatus(checkbox) {
    const projectId = checkbox.dataset.projectId;
    const taskId = checkbox.dataset.taskId;
    const completed = checkbox.checked;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/tasks/${taskId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ completed: completed })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update task');
        }
        
        // Update UI
        const taskItem = checkbox.closest('.task-item');
        if (completed) {
            taskItem.classList.add('completed');
        } else {
            taskItem.classList.remove('completed');
        }
        
    } catch (error) {
        console.error('Error updating task:', error);
        checkbox.checked = !completed; // Revert checkbox state
        alert('Failed to update task status');
    }
}

// Feedback modal functionality
function showFeedbackModal() {
    document.getElementById('feedbackModal').style.display = 'block';
}

// Star rating functionality
document.querySelectorAll('.rating-stars .fas').forEach(star => {
    star.addEventListener('click', () => {
        const rating = parseInt(star.dataset.rating);
        document.getElementById('rating').value = rating;
        
        // Update star display
        document.querySelectorAll('.rating-stars .fas').forEach(s => {
            if (parseInt(s.dataset.rating) <= rating) {
                s.classList.add('active');
            } else {
                s.classList.remove('active');
            }
        });
    });
});

// Close modal when clicking X
document.querySelector('.close-btn').addEventListener('click', () => {
    document.getElementById('feedbackModal').style.display = 'none';
});

// Form submissions
document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    // Implement task form submission
});

document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    // Implement feedback form submission
});
</script>
{% endblock %}
